(window.webpackJsonp=window.webpackJsonp||[]).push([[163],{409:function(s,t,a){"use strict";a.r(t);var n=a(2),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("blockquote",[a("p",[s._v("这是阅读《MongoDB实战》所做的，关于基础、编码和优化方面的读书笔记。")])]),s._v(" "),a("h2",{attrs:{id:"mongodb特性和介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mongodb特性和介绍"}},[s._v("#")]),s._v(" MongoDB特性和介绍")]),s._v(" "),a("h3",{attrs:{id:"_1-简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-简介"}},[s._v("#")]),s._v(" 1. 简介")]),s._v(" "),a("p",[s._v("MongoDB的特点：扩展策略、直观的数据模型。在mongodb中，编程语言定义的对象能被“原封不变”地持久化，消除对象结构和程序映射的复杂性。")]),s._v(" "),a("h3",{attrs:{id:"_2-主要特性"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-主要特性"}},[s._v("#")]),s._v(" 2. 主要特性")]),s._v(" "),a("h4",{attrs:{id:"数据模型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据模型"}},[s._v("#")]),s._v(" 数据模型")]),s._v(" "),a("p",[s._v("关系型与正规化：对于关系型数据库，数据表本质上是"),a("strong",[s._v("扁平的")]),s._v("，因此表示多个一对多关系就需要多张表。经常用到的技术是"),a("strong",[s._v("拆表")]),s._v("，这种技术是"),a("strong",[s._v("正规化")]),s._v("。")]),s._v(" "),a("p",[s._v("但对于Mongo来说，文档支持嵌套等多种格式，无需事先定义"),a("strong",[s._v("Schema")]),s._v("。")]),s._v(" "),a("h4",{attrs:{id:"即时查询"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#即时查询"}},[s._v("#")]),s._v(" 即时查询")]),s._v(" "),a("p",[s._v("mysql和mongodb都支持"),a("strong",[s._v("即时查询")]),s._v("，不同的是：前者依赖正则化的模型；后者假定查询字段是存储与文档中的。")]),s._v(" "),a("h4",{attrs:{id:"二级索引"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二级索引"}},[s._v("#")]),s._v(" 二级索引")]),s._v(" "),a("p",[s._v("mongodb支持二级索引，是通过b-tree实现的。")]),s._v(" "),a("h4",{attrs:{id:"复制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#复制"}},[s._v("#")]),s._v(" 复制")]),s._v(" "),a("p",[s._v("通过"),a("strong",[s._v("副本集")]),s._v("的拓扑结构来提供复制功能，其目的是："),a("strong",[s._v("提供数据的冗余")]),s._v("。")]),s._v(" "),a("p",[s._v("副本集的主节点能接受读写操作，但从节点是只读的。主节点出问题，会自动故障转移，选取一个从节点升级为主节点。")]),s._v(" "),a("h4",{attrs:{id:"写速度和持久性"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#写速度和持久性"}},[s._v("#")]),s._v(" 写速度和持久性")]),s._v(" "),a("p",[s._v("写速度：给定时间内，数据库可以处理的插入、更新和删除操作的数量。")]),s._v(" "),a("p",[s._v("持久性：数据库保持上述写操作的结果不改变的，所用的时间长短。")]),s._v(" "),a("p",[s._v("DB领域，"),a("strong",[s._v("写速度和持久性存在一种相反关系")]),s._v("。很好理解，例如memcached，直接写入内存，写速度非常快，但同时数据完全易失。")]),s._v(" "),a("p",[s._v("mongodb的写操作，默认是"),a("strong",[s._v("fire-and-forget")]),s._v("：通过TCP发送写操作，不要求数据库应答。用户可以开启"),a("strong",[s._v("安全模式")]),s._v("，保证写操作正确无误写入db。并且安全模式可以配置，用于"),a("strong",[s._v("阻塞操作")]),s._v("。")]),s._v(" "),a("p",[s._v("对于高容量、低价值数据（点击流、日志），默认模式更优；对于重要数据，倾向于安全模式。")]),s._v(" "),a("p",[s._v("mongo中，"),a("strong",[s._v("Journaling日志")]),s._v("默认开启。所有写操作会被提交到一个只能追加的日志中。以应对故障后的，重启修复服务。")]),s._v(" "),a("h4",{attrs:{id:"数据库扩展"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据库扩展"}},[s._v("#")]),s._v(" 数据库扩展")]),s._v(" "),a("ul",[a("li",[s._v("垂直扩展（向上扩展）：升级硬件，来提高单点性能")]),s._v(" "),a("li",[s._v("水平扩展（向外扩展）：将数据库分布到多台机器，是基于"),a("strong",[s._v("自动分片")]),s._v("。其中，单独的分片由一个副本集组成，至少有2个节点，保证没有单点失败。")])]),s._v(" "),a("h3",{attrs:{id:"_3-核心服务器和工具"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-核心服务器和工具"}},[s._v("#")]),s._v(" 3. 核心服务器和工具")]),s._v(" "),a("h4",{attrs:{id:"核心服务器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#核心服务器"}},[s._v("#")]),s._v(" 核心服务器")]),s._v(" "),a("p",[s._v("通过"),a("code",[s._v("mongod")]),s._v("可以运行核心服务器。数据文件存储在"),a("code",[s._v("/data/db")]),s._v("中。如果下载编译mongo的源代码，需要手动创建"),a("code",[s._v("/data/db")]),s._v("，并且为其分配权限。")]),s._v(" "),a("p",[s._v("其中，mongo的"),a("strong",[s._v("内存管理")]),s._v("是由操作系统来处理的。数据文件通过"),a("code",[s._v("mmap()")]),s._v("系统API，映射成系统的虚拟内存。")]),s._v(" "),a("h4",{attrs:{id:"命令行"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#命令行"}},[s._v("#")]),s._v(" 命令行")]),s._v(" "),a("p",[s._v("是基于JavaScript编写的。所以能看到很多通用的语法，以及输出的格式。")]),s._v(" "),a("h4",{attrs:{id:"数据库驱动"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据库驱动"}},[s._v("#")]),s._v(" 数据库驱动")]),s._v(" "),a("p",[s._v("针对多个语言，都提供了"),a("strong",[s._v("驱动")]),s._v("使用。并且风格几乎保持统一的API接口。")]),s._v(" "),a("h4",{attrs:{id:"命令行工具"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#命令行工具"}},[s._v("#")]),s._v(" 命令行工具")]),s._v(" "),a("p",[s._v("安装到MaxOS后，全局会多出以下命令：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("mongodump")]),s._v("和"),a("code",[s._v("mongorestore")]),s._v("：前者用"),a("code",[s._v("BSON")]),s._v("格式，来备份数据库数据。方便后者恢复。")]),s._v(" "),a("li",[a("code",[s._v("mongoexport")]),s._v("和"),a("code",[s._v("mongoimport")]),s._v("：导入导出JSON、CSV和TSV格式数据。")])]),s._v(" "),a("h3",{attrs:{id:"_4-mongo的场景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-mongo的场景"}},[s._v("#")]),s._v(" 4. Mongo的场景")]),s._v(" "),a("p",[s._v("适用于"),a("strong",[s._v("事先无法知晓数据结构")]),s._v("的数据，或者"),a("strong",[s._v("数据结构经常不确定性较大")]),s._v("的数据。")]),s._v(" "),a("p",[s._v("除此之外，还适用于"),a("strong",[s._v("与分析相关的场景")]),s._v("。mongo提供一种"),a("strong",[s._v("固定集合")]),s._v("，常用于日志，特点是"),a("strong",[s._v("分配的大小固定")]),s._v("，类似于循环队列。")]),s._v(" "),a("h3",{attrs:{id:"_5-局限"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-局限"}},[s._v("#")]),s._v(" 5. 局限")]),s._v(" "),a("p",[s._v("由于使用内存映射，32位系统只能对4GB内存寻址。一半内存被os占用，那么只有2GB能用来做映射文件。所以，"),a("strong",[s._v("必须部署在64位操作系统上")]),s._v("。")]),s._v(" "),a("h2",{attrs:{id:"程序编写基础"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#程序编写基础"}},[s._v("#")]),s._v(" 程序编写基础")]),s._v(" "),a("p",[s._v("mongo驱动的find方法，返回的是"),a("strong",[s._v("游标对象")]),s._v("，可以理解为迭代器的下标。在NodeJS中，它的名字和类型是"),a("code",[s._v("Cursor")]),s._v("。")]),s._v(" "),a("p",[s._v("在Nodejs中，")]),s._v(" "),a("h3",{attrs:{id:"_1-驱动工作原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-驱动工作原理"}},[s._v("#")]),s._v(" 1. 驱动工作原理")]),s._v(" "),a("p",[s._v("主要有3个功能：")]),s._v(" "),a("ol",[a("li",[s._v("生成MongoDB对象的ID，它是存储在"),a("code",[s._v("_id")]),s._v("字段中的默认值")]),s._v(" "),a("li",[s._v("驱动会把特定语言的文档表述，和"),a("code",[s._v("BSON")]),s._v("互换")]),s._v(" "),a("li",[s._v("使用TCP套接字与数据库通信")])]),s._v(" "),a("h4",{attrs:{id:"对象id"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#对象id"}},[s._v("#")]),s._v(" 对象ID")]),s._v(" "),a("p",[s._v("在自带的交互式命令行中:")]),s._v(" "),a("div",{staticClass:"language-javascript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" id "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ObjectId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ObjectId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5d9413867cc8dacf9247fe3e"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("对于生成的"),a("code",[s._v("5d9413867cc8dacf9247fe3e")]),s._v(":")]),s._v(" "),a("pre",[a("code",[s._v("- 5d941386 ，这4个字节是时间戳，单位秒数\n- 7cc8da，机器ID\n- cf92，进程ID\n- 47fe3e，计数器\n")])]),s._v(" "),a("h3",{attrs:{id:"_2-安全写入模式-write-concern"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-安全写入模式-write-concern"}},[s._v("#")]),s._v(" 2. 安全写入模式(Write Concern)")]),s._v(" "),a("p",[s._v("对所有的写操作（插入、更新或删除）都能开启此模式。以此保证，操作一定在数据库层面生效。")]),s._v(" "),a("p",[s._v("在v4.0中，以insert为例，文档如下：")]),s._v(" "),a("div",{staticClass:"language-javascript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[s._v("db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("collection"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("insert")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("document or array "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("of")]),s._v(" documents"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n     writeConcern"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("document"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n     ordered"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("boolean"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("关于 Write Concern的详细参数，可以看这篇文档：https://docs.mongodb.com/manual/reference/write-concern/")]),s._v(" "),a("p",[s._v("其中，重要的是"),a("code",[s._v("w")]),s._v(" 参数，它可以指定是否使用应答写入。目前默认是1，应答式写入。设置为0，则是非应答式。")]),s._v(" "),a("h2",{attrs:{id:"面向文档的数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#面向文档的数据"}},[s._v("#")]),s._v(" 面向文档的数据")]),s._v(" "),a("h3",{attrs:{id:"_1-schema-设计原则"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-schema-设计原则"}},[s._v("#")]),s._v(" 1. Schema 设计原则")]),s._v(" "),a("p",[s._v("设计数据库Schema式根据数据库特点和应用程序需求的情况下，为数据集选择最佳表述的过程。")]),s._v(" "),a("h3",{attrs:{id:"_2-设计电子商务数据模型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-设计电子商务数据模型"}},[s._v("#")]),s._v(" 2. 设计电子商务数据模型")]),s._v(" "),a("h4",{attrs:{id:"一对多：产品和分类"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一对多：产品和分类"}},[s._v("#")]),s._v(" 一对多：产品和分类")]),s._v(" "),a("p",[s._v("假设一个电商场景，要对一个商品doc进行设计。对于商品，它有多个分类category，因此需要"),a("strong",[s._v("一对多操作")]),s._v("，同时，mongo不支持联结操作（join）。")]),s._v(" "),a("p",[s._v("因此解决方案是，在商品的一个字段中，保存"),a("strong",[s._v("分类指针")]),s._v("的数组。这里的指针，就是mongo中的对象ID。")]),s._v(" "),a("p",[s._v("下面是一个简单的例子：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('> db.products.find()\n{ "_id" : ObjectId("5d9423257cc8dacf9247fe41"), "categories" : [ ObjectId("5d9423017cc8dacf9247fe3f") ] }\n> db.categories.find({})\n{ "_id" : ObjectId("5d9423017cc8dacf9247fe3f"), "name" : "分类1" }\n{ "_id" : ObjectId("5d9423037cc8dacf9247fe40"), "name" : "分类2" }\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h4",{attrs:{id:"一对多：用户与订单"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一对多：用户与订单"}},[s._v("#")]),s._v(" 一对多：用户与订单")]),s._v(" "),a("p",[s._v("和前面的关系不同，这里的“多”体现在“订单”上。这里的订单中，保存着指向用户的指针。")]),s._v(" "),a("h4",{attrs:{id:"评论"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#评论"}},[s._v("#")]),s._v(" 评论")]),s._v(" "),a("p",[s._v("每个产品会有多个评论，而每个评论，可能会有点赞人列表。当要展示返回给前端的时候，需要获取产品评论，并且获取点赞人列表。")]),s._v(" "),a("p",[s._v("方案1：点赞人列表，保存着由指针组成的集合。可以先查询产品评论后，再对点赞做2次查询。")]),s._v(" "),a("p",[s._v("方案2：由于仅需要点赞人的头像和名称（少量信息），可以使用"),a("strong",[s._v("去正规化")]),s._v("，不再保存指针，而是简单信息。")]),s._v(" "),a("p",[s._v("上面2种方案，都可以防止重复点赞的发生。")]),s._v(" "),a("h3",{attrs:{id:"_3-具体细节"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-具体细节"}},[s._v("#")]),s._v(" 3. 具体细节")]),s._v(" "),a("h4",{attrs:{id:"数据库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据库"}},[s._v("#")]),s._v(" 数据库")]),s._v(" "),a("p",[s._v("即使使用"),a("code",[s._v("use")]),s._v("切换一个新的数据库，如果没有insert数据，该数据库并不会创建。")]),s._v(" "),a("p",[s._v("mongodb会为数据、集合、索引进行空间分配，并且采取的是"),a("strong",[s._v("预分配")]),s._v("的方式，每次空间不够的时候，扩充2倍。")]),s._v(" "),a("p",[s._v("通过 "),a("code",[s._v("db.stats()")]),s._v(" 可以查看当前db的状态，下面是一个示例：")]),s._v(" "),a("div",{staticClass:"language-javascript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("stats")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"db"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"info_keeper"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"collections"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"views"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"objects"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"avgObjSize"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("255.8181818181818")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dataSize"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2814")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 数据库中BSON对象实际大小")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"storageSize"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("86016")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 包含了集合增长的预留空间和未分配的已删除空间")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"numExtents"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"indexes"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"indexSize"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("155648")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 数据库索引大小的空间")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"fsUsedSize"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("86272356352")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"fsTotalSize"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("250685575168")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ok"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("h4",{attrs:{id:"集合"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#集合"}},[s._v("#")]),s._v(" 集合")]),s._v(" "),a("p",[s._v("1、重命名操作：")]),s._v(" "),a("div",{staticClass:"language-javascript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" use test\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("orders"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("renameCollection")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"orders2014"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("2、固定集合")]),s._v(" "),a("p",[s._v("对应日志统计之类的、"),a("strong",[s._v("只有最近的数据才有价值")]),s._v("的场景下，可以使用"),a("strong",[s._v("固定集合")]),s._v("：一旦容量到上限，后续插入会逐步覆盖最先插入的文档。")]),s._v(" "),a("p",[s._v("创建时候，需要同时指定"),a("code",[s._v("createCollection")]),s._v("的capped和size参数：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("db.createCollection('logs',{ capped : true, size : 5242880 })\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("为了性能优化，mongo"),a("strong",[s._v("不会为固定集合创建针对"),a("code",[s._v("_id")]),s._v("的索引")]),s._v("。同时，不能从中删除doc，也不能执行任何更改文档大小的更新操作。")]),s._v(" "),a("p",[s._v("3、键名选择")]),s._v(" "),a("p",[a("strong",[s._v("慎重选择键名")]),s._v("，例如，用"),a("code",[s._v("dob")]),s._v("代替"),a("code",[s._v("date_of_birth")]),s._v("，一个文档可以省下10字节。")]),s._v(" "),a("h2",{attrs:{id:"查询和聚合"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查询和聚合"}},[s._v("#")]),s._v(" 查询和聚合")]),s._v(" "),a("h3",{attrs:{id:"_1-查询常见技巧"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-查询常见技巧"}},[s._v("#")]),s._v(" 1. 查询常见技巧")]),s._v(" "),a("p",[a("strong",[s._v("分页查询")]),s._v("可以通过"),a("code",[s._v("skip")]),s._v("和"),a("code",[s._v("limit")]),s._v("配合使用实现。")]),s._v(" "),a("p",[a("strong",[s._v("空值查询")]),s._v("可以通过驱动的空值字面量实现，比如在node中，想查询"),a("code",[s._v("logs")]),s._v("中不包含"),a("code",[s._v("name")]),s._v("字段的记录："),a("code",[s._v("db.logs.find({ name: null })")]),s._v("。")]),s._v(" "),a("p",[a("strong",[s._v("减少序列化和网络传输")]),s._v("，可以通过给定find的第二个参数，来选定数据库返回给驱动的文档的字段，比如："),a("code",[s._v("db.products.find({}, {_id: 1})")]),s._v("。这条命令，只返回文档的"),a("code",[s._v("_id")]),s._v("字段。")]),s._v(" "),a("p",[a("strong",[s._v("复合索引")]),s._v("，复合索引的设定，遵循着「从准确到宽泛」的规则。比如对于订单记录，有着下单人和时间2个字段。应该先为下单人字段设置索引，再为时间字段设置索引。可以理解为前者是精确查找，可以大大缩小查找结果集；后者是范围查找。")]),s._v(" "),a("p",[a("strong",[s._v("嵌套字段查询")]),s._v("，对于负责对象字段的查询，直接通过"),a("code",[s._v(".")]),s._v("运算符即可。例如："),a("code",[s._v("db.demos.find({a: {b : 1}})")]),s._v("和"),a("code",[s._v('db.demos.find({"a.b": 1})')]),s._v(" 是等效的。")]),s._v(" "),a("h3",{attrs:{id:"_2-常见查询语言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-常见查询语言"}},[s._v("#")]),s._v(" 2. 常见查询语言")]),s._v(" "),a("p",[s._v("MongoDB的查询本质：实例化了一个游标，并获取它的结果集。")]),s._v(" "),a("h4",{attrs:{id:"范围查询"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#范围查询"}},[s._v("#")]),s._v(" 范围查询")]),s._v(" "),a("p",[s._v("范围操作符用法很简单，但注意：不要在范围查找时候误用"),a("strong",[s._v("重复搜索键")]),s._v("。")]),s._v(" "),a("p",[s._v("错误："),a("code",[s._v("db.users.find({age: { $gte: 0 }, age: { $lte: 30 } })")])]),s._v(" "),a("p",[s._v("正确："),a("code",[s._v("db.users.find({age: {$gte: 0, $lte: 30}})")])]),s._v(" "),a("h4",{attrs:{id:"集合操作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#集合操作"}},[s._v("#")]),s._v(" 集合操作")]),s._v(" "),a("p",[s._v("集合操作符一共有3个："),a("code",[s._v("$in")]),s._v("、"),a("code",[s._v("$all")]),s._v("、"),a("code",[s._v("$nin")]),s._v("。")]),s._v(" "),a("p",[s._v("in和nin是一对，in相当于使用多个OR操作符："),a("code",[s._v("db.products.find({'tags': {$in: [ObjectId('...'), ObjectId('...')]}})")])]),s._v(" "),a("p",[s._v("all的作用属性，必须是数组形式："),a("code",[s._v("db.products.find({tags: {$all: ['a', 'b']}})")])]),s._v(" "),a("p",[s._v("⚠️注意：in和all可以利用索引；nin不能利用索引，只能使用"),a("strong",[s._v("集合扫描")]),s._v("。这和BTree结构有关。")]),s._v(" "),a("h4",{attrs:{id:"布尔操作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#布尔操作"}},[s._v("#")]),s._v(" 布尔操作")]),s._v(" "),a("p",[s._v("常见的有："),a("code",[s._v("$ne")]),s._v("、"),a("code",[s._v("$not")]),s._v("、 "),a("code",[s._v("$or")]),s._v("、 "),a("code",[s._v("$and")]),s._v("、"),a("code",[s._v("$exists")]),s._v("。同样的，"),a("code",[s._v("$ne")]),s._v("不能利用索引。")]),s._v(" "),a("p",[s._v("对于not的使用，如果使用的操作符或者正则表达式不存在否定形式，才配合not。例如大于，就有小于等于操作符。")]),s._v(" "),a("p",[s._v("对与or的使用，or可以"),a("strong",[s._v("表示不同键的值的关系")]),s._v("，而in只能表示一个键的值的关系。例如："),a("code",[s._v("db.products.find({ $or: [{ name: 'a' }, { name: 'b' }] })")])]),s._v(" "),a("h4",{attrs:{id:"子文档"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#子文档"}},[s._v("#")]),s._v(" 子文档")]),s._v(" "),a("p",[s._v("对于内嵌对象匹配，用"),a("code",[s._v(".")]),s._v("运算符即可，正如前面的嵌套字段查询所述。")]),s._v(" "),a("p",[a("strong",[s._v("不推荐")]),s._v("对于整个对象的查询，需要严格保证查询字段的顺序。")]),s._v(" "),a("h4",{attrs:{id:"数组"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数组"}},[s._v("#")]),s._v(" 数组")]),s._v(" "),a("p",[s._v("如果数组中元素是基础对象，那么直接查询即可。mongo识别字段是数组类型，会自动查询字段是否位于其中。")]),s._v(" "),a("p",[s._v("例如：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" db.products.insert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("tags: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'a'")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'b'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nWriteResult"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nInserted"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" db.products.find"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("tags: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'a'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_id"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" ObjectId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5d948025da0946c664997712"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tags"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"a"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"b"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("如果数组中元素是负责对象，可以借助"),a("code",[s._v(".")]),s._v("运算符进行访问：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" db.products.insert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("address: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("name: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'home'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nWriteResult"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nInserted"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" db.products.find"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"address.name"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'home'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_id"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" ObjectId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5d948055da0946c664997713"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"address"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"home"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("同样地，你也可以指定针对特定顺序的数组元素：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" db.products.find"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"address.0.name"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'home'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_id"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" ObjectId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5d948055da0946c664997713"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"address"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"home"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("如果要同时将"),a("strong",[s._v("多个条件限制在同一个子文档")]),s._v("上，下面是错误和正确的做法👇")]),s._v(" "),a("p",[s._v("错误："),a("code",[s._v("db.products.find({\"address.name\": 'home', 'address.state': 'NY'})")])]),s._v(" "),a("p",[s._v("正确："),a("code",[s._v("db.products.find({address: {$elemMatch: {name: 'home', state: 'NY'} }})")])]),s._v(" "),a("h4",{attrs:{id:"javascript查询"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#javascript查询"}},[s._v("#")]),s._v(" Javascript查询")]),s._v(" "),a("p",[s._v("对于一些复杂查询，借助"),a("code",[s._v("$where")]),s._v("可以使用js表达式。还是以刚才的数据为例：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" db.products.find"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$where")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"function() {return this.address && this.address.length}"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_id"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" ObjectId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5d948055da0946c664997713"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"address"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"home"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("在使用的时候，需要启动js解释器和上下文，因此"),a("strong",[s._v("开销大")]),s._v("。在使用的时候，尽量带上其他标准查询操作，来缩小查询范围。")]),s._v(" "),a("p",[s._v("除此之外，还有注入攻击的可能。主要体现在驱动使用时候，如果后端传给db的字段是没做检验的，可能发生注入攻击。")]),s._v(" "),a("h4",{attrs:{id:"正则表达式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#正则表达式"}},[s._v("#")]),s._v(" 正则表达式")]),s._v(" "),a("p",[s._v("主要体现在驱动使用上。")]),s._v(" "),a("p",[s._v("如果支持js的正则，那么可以: "),a("code",[s._v("find({text: /best/i})")])]),s._v(" "),a("p",[s._v("如果不支持，那么："),a("code",[s._v("find({text: {$regex: 'best', $options: 'i'}})")])]),s._v(" "),a("h4",{attrs:{id:"类型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#类型"}},[s._v("#")]),s._v(" 类型")]),s._v(" "),a("p",[s._v("通过"),a("code",[s._v("$type")]),s._v("，可以根据指定字段类型进行查询。不同的值，代表不同的类型。请见官方文档。")]),s._v(" "),a("h3",{attrs:{id:"_3-查询选项"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-查询选项"}},[s._v("#")]),s._v(" 3. 查询选项")]),s._v(" "),a("h4",{attrs:{id:"投影"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#投影"}},[s._v("#")]),s._v(" 投影")]),s._v(" "),a("p",[s._v("1、使用选择字段进行返回，降低网络传输："),a("code",[s._v("find")]),s._v("给定第二个参数。")]),s._v(" "),a("p",[s._v("2、返回保存在结果数组中的某个范围的值："),a("code",[s._v("$slice([start, limit])")]),s._v("。例如："),a("code",[s._v("db.products.find({}, { comments: {$slice: 12}})")])]),s._v(" "),a("h4",{attrs:{id:"排序"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#排序"}},[s._v("#")]),s._v(" 排序")]),s._v(" "),a("p",[s._v("能够对"),a("strong",[s._v("多个字段")]),s._v("进行升序/降序排列。例如："),a("code",[s._v("db.comments.find().sort({rating: -1, votes: -1})")])]),s._v(" "),a("h4",{attrs:{id:"skip和limit"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#skip和limit"}},[s._v("#")]),s._v(" skip和limit")]),s._v(" "),a("p",[s._v("如果向skip传入很大的值，需要扫描同等数量的文档，浪费资源。")]),s._v(" "),a("p",[s._v("最好的方法是：通过查询条件，缩小要扫描的文档。")]),s._v(" "),a("h3",{attrs:{id:"_4-聚合指令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-聚合指令"}},[s._v("#")]),s._v(" 4. 聚合指令")]),s._v(" "),a("p",[s._v("在v2的版本中，mongo只能通过map、reduce等基础操作来支持聚合搜索。但在v3的版本后，mongo本身提供了丰富的聚合阶段("),a("a",{attrs:{href:"https://docs.mongodb.com/manual/reference/operator/aggregation-pipeline",target:"_blank",rel:"noopener noreferrer"}},[s._v("aggregation pipeline"),a("OutboundLink")],1),s._v(")和聚合运算符("),a("a",{attrs:{href:"https://docs.mongodb.com/manual/reference/operator/aggregation/",target:"_blank",rel:"noopener noreferrer"}},[s._v("aggregation operator"),a("OutboundLink")],1),s._v(")。")]),s._v(" "),a("p",[s._v("以"),a("code",[s._v("$group")]),s._v("和"),a("code",[s._v("$sum")]),s._v("为例，插入了a和b两种售卖货物以及价钱：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" db.sales."),a("span",{pre:!0,attrs:{class:"token function-name function"}},[s._v("find")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_id"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" ObjectId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5d98ca8094ffea590a8a85c6"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"a"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"coin"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_id"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" ObjectId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5d98ca8694ffea590a8a85c7"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"a"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"coin"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_id"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" ObjectId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5d98ca9094ffea590a8a85c8"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"b"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"coin"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("800")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("利用聚合操作，就可以便捷算出每种货物的总价：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" db.sales.aggregate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$group")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" _id: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$name")]),s._v('"')]),s._v(", total: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$sum")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$coin")]),s._v('"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_id"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"b"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"total"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("800")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_id"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"a"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"total"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("300")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("最后说一下，聚合的意义在于数据库提供给使用者此种功能以及相关优化。当然，使用者完全可以在逻辑层面查询到需要的集合，代码中进行计算。但对于服务的提供商，完整的服务是必不可少的。")]),s._v(" "),a("h2",{attrs:{id:"更新、原子操作与删除"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#更新、原子操作与删除"}},[s._v("#")]),s._v(" 更新、原子操作与删除")]),s._v(" "),a("h3",{attrs:{id:"_1-文档更新入门"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-文档更新入门"}},[s._v("#")]),s._v(" 1. 文档更新入门")]),s._v(" "),a("p",[s._v("文档更新分为：替换更新和针对性更新。相较而言，"),a("strong",[s._v("针对性更新")]),s._v("具有性能好、传输数据少和允许原子性更新的优点。")]),s._v(" "),a("p",[s._v("利用"),a("code",[s._v("$set")]),s._v("和"),a("code",[s._v("$push")]),s._v("可以针对文档和其中的数组字段进行针对性更新，下面是针对性更新的例子：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("db.products.update"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" _id: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$set")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        quantity: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("500")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("如果是替换更新，遇到增加计数器值之类的场景，在不使用乐观锁的情况下，无法保证原子性更新。因为需要先读出数据，然后再更新。此过程中，可能会有其他并发程序重写字段，从而造成脏数据。")]),s._v(" "),a("p",[s._v("以更新计数器的针对性更新为例：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("db.products.update"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" sku: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"abc123"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$inc")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" quantity: -1 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h3",{attrs:{id:"_2-电子商务数据模型中的更新"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-电子商务数据模型中的更新"}},[s._v("#")]),s._v(" 2. 电子商务数据模型中的更新")]),s._v(" "),a("h4",{attrs:{id:"冗余字段设计"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#冗余字段设计"}},[s._v("#")]),s._v(" 冗余字段设计")]),s._v(" "),a("p",[s._v("对于一些常见的结果，比如：总数、平均值等。为了避免每次都"),a("strong",[s._v("重新聚合运算")]),s._v("，可以在文档中"),a("strong",[s._v("保存额外的字段缓存")]),s._v("相关数据。")]),s._v(" "),a("p",[s._v("之后的业务查询，仅仅需要查询一次即可。")]),s._v(" "),a("h4",{attrs:{id:"操作符"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#操作符"}},[s._v("#")]),s._v(" "),a("code",[s._v("$")]),s._v("操作符")]),s._v(" "),a("p",[s._v("作用：确定数组中一个要被更新的元素的位置，而不用具体指定该元素在数组中的位置。")]),s._v(" "),a("p",[s._v("如下所示，不需要知道在grades数组中匹配的具体位置，用"),a("code",[s._v("$")]),s._v("指代即可：")]),s._v(" "),a("div",{staticClass:"language-javascript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("students"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("insert")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_id"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"grades"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("85")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("students"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("updateOne")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" _id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" grades"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" $"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"grades.$"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("82")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h4",{attrs:{id:"upsert操作符"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#upsert操作符"}},[s._v("#")]),s._v(" "),a("code",[s._v("upsert")]),s._v("操作符")]),s._v(" "),a("p",[s._v("作用：如果不存在，则会自动"),a("code",[s._v("insert")]),s._v("。")]),s._v(" "),a("p",[s._v("对于添加到商品到购物车等场景，非常适用。")]),s._v(" "),a("h3",{attrs:{id:"_3-事务性工作流"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-事务性工作流"}},[s._v("#")]),s._v(" 3. 事务性工作流")]),s._v(" "),a("p",[s._v("这里主要使用的是"),a("code",[s._v("findAndModify")]),s._v("命令。这个命令，支持传入query参数，来做匹配筛选；支持update，来做针对性更新（原子更新）。最重要的特性是："),a("strong",[s._v("可以根据"),a("code",[s._v("new")]),s._v("参数，来返回更新前后的文档数据状态")]),s._v("。")]),s._v(" "),a("p",[s._v("借助可以返回更新文档数据的特性，可以mock一下mongo 4.0之前不支持的事务特性。思路是：")]),s._v(" "),a("ol",[a("li",[s._v("获取最初的文档数据")]),s._v(" "),a("li",[s._v("利用findAndModify进行针对性更新，更新字段中需要携带本次的更新标示（比如时间戳）。findAndModify操作符回返回更新后的字段。")]),s._v(" "),a("li",[s._v("将更新后的字段中的更新标示与本地保存的标示做对比，如果不相同，说明有别的端更新了数据，数据发生了污染，为了保证事务原子性的特点，将文档恢复为第1步获得原始数据；如果相同，那么继续进行。")])]),s._v(" "),a("p",[s._v("在MongoDB 4.0中，就是通过类似第二步的思路，提供了一个seesionID来实现了事务的，保证了事务特性。")]),s._v(" "),a("h3",{attrs:{id:"_4-更多的更新命令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-更多的更新命令"}},[s._v("#")]),s._v(" 4. 更多的更新命令")]),s._v(" "),a("p",[s._v("update：multi参数不给，默认只更新匹配到的第一个文档。")]),s._v(" "),a("p",[s._v("unset：删除文档中的指定键。")]),s._v(" "),a("p",[s._v("rename：重命名键。")]),s._v(" "),a("p",[s._v("addToSet：数组中不存在时候，才会加入。")]),s._v(" "),a("p",[s._v("pull：删除数组指定位置的元素。")]),s._v(" "),a("h3",{attrs:{id:"_5-更新本质和优化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-更新本质和优化"}},[s._v("#")]),s._v(" 5. 更新本质和优化")]),s._v(" "),a("p",[s._v("更新分为3种：")]),s._v(" "),a("ul",[a("li",[s._v("只改变单值，但BSON文档不变："),a("code",[s._v("$inc")]),s._v("操作符")]),s._v(" "),a("li",[s._v("改变文档和结构，会重写整个文档："),a("code",[s._v("$push")])]),s._v(" "),a("li",[s._v("改变文档造成空间不够，全部整体迁移到新空间：提前利用"),a("strong",[s._v("填充因子")]),s._v("来减少影响")])])])}),[],!1,null,null,null);t.default=e.exports}}]);