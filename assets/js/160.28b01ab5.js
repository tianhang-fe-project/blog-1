(window.webpackJsonp=window.webpackJsonp||[]).push([[160],{398:function(_,t,v){"use strict";v.r(t);var a=v(2),r=Object(a.a)({},(function(){var _=this,t=_.$createElement,v=_._self._c||t;return v("ContentSlotsDistributor",{attrs:{"slot-key":_.$parent.slotKey}},[v("p",[_._v("Keywords: 缓存抗读写、数据库扩展（列扩展+行扩展）、批量操作、计数系统与业务系统分离、业务拓展性、读写效率")]),_._v(" "),v("h2",{attrs:{id:"_1-一些概念"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_1-一些概念"}},[_._v("#")]),_._v(" 1. 一些概念")]),_._v(" "),v("p",[_._v("QPS：并发量 / 平均响应时间。即每秒的响应请求数，也是最大吞吐能力。")]),_._v(" "),v("h2",{attrs:{id:"_2-思路考虑"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_2-思路考虑"}},[_._v("#")]),_._v(" 2. 思路考虑")]),_._v(" "),v("p",[_._v("Redis做缓存层，数据固化落到DB上。核心数据设计：")]),_._v(" "),v("ul",[v("li",[_._v("mysql：t_count(msg_id, parise_count)")]),_._v(" "),v("li",[_._v("redis(k-v): key: msg_id; value: praise_count")])]),_._v(" "),v("p",[_._v("物理机依托mysql和redis，"),v("strong",[_._v("水平拓展")]),_._v("不是问题。")]),_._v(" "),v("h2",{attrs:{id:"_3-计数系统的难点与优化"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_3-计数系统的难点与优化"}},[_._v("#")]),_._v(" 3. 计数系统的难点与优化")]),_._v(" "),v("h3",{attrs:{id:"_3-1-真实业务场景"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-真实业务场景"}},[_._v("#")]),_._v(" 3.1 真实业务场景")]),_._v(" "),v("p",[v("strong",[_._v("记数系统的难点在于：业务拓展性，以及读写效率")]),_._v("。")]),_._v(" "),v("p",[_._v("业务拓展性：体现在下面这张图中，一个消息中，除了点赞数，还有评论、转发、阅读数。")]),_._v(" "),v("p",[v("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOxGzpnZYxOulLGX3uicUg1mzeXGCSzMnBl3ibv6nUx3OA115ypmiaWKYlMNNzDq5mrS4tpmANKpvceIg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1",alt:"img"}})]),_._v(" "),v("p",[_._v("效率：一个页面中，有很多条消息（只能在代码中循环每一条消息）。")]),_._v(" "),v("h3",{attrs:{id:"_3-2-一种不算完美的解决方案"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-一种不算完美的解决方案"}},[_._v("#")]),_._v(" 3.2 一种不算完美的解决方案")]),_._v(" "),v("p",[_._v("Redis的k-v设计上，k的生成规则可以使用："),v("code",[_._v("msg_id:业务flag")]),_._v(" 的格式。比如对于第一条消息的阅读数，它的key就是："),v("code",[_._v("1:read")]),_._v("；对于评论数："),v("code",[_._v("1:comment")]),_._v("。")]),_._v(" "),v("p",[_._v("在针对指定消息查询的时候，需要对redis发起多次RPC调用。浪费次数。")]),_._v(" "),v("p",[_._v("Mysql的设计上，常见就是"),v("strong",[_._v("列扩展")]),_._v("。如下所示：")]),_._v(" "),v("table",[v("thead",[v("tr",[v("th",[_._v("msg_id")]),_._v(" "),v("th",[_._v("read_count")]),_._v(" "),v("th",[_._v("comment_count")])])]),_._v(" "),v("tbody",[v("tr",[v("td",[_._v("1")]),_._v(" "),v("td",[_._v("100000")]),_._v(" "),v("td",[_._v("1000")])]),_._v(" "),v("tr",[v("td",[_._v("2")]),_._v(" "),v("td",[_._v("200000")]),_._v(" "),v("td",[_._v("2000")])])])]),_._v(" "),v("p",[_._v("但是更改表结构的时候，存在着效率问题。")]),_._v(" "),v("h3",{attrs:{id:"_3-3-比较好的方案"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-比较好的方案"}},[_._v("#")]),_._v(" 3.3 比较好的方案")]),_._v(" "),v("p",[_._v("针对Redis，能做的就是降低单独消息的RPC调用次数，减少Redis访问次数。"),v("strong",[_._v("可以将count的计数，放在同一个value中")]),_._v("。如下所示：")]),_._v(" "),v("table",[v("thead",[v("tr",[v("th",[_._v("Key")]),_._v(" "),v("th",[_._v("value")])])]),_._v(" "),v("tbody",[v("tr",[v("td",[_._v("1")]),_._v(" "),v("td",[_._v("100000:1000")])])])]),_._v(" "),v("p",[_._v("针对Mysql，可以使用"),v("strong",[_._v("行扩展")]),_._v("来解决列扩展问题，表结构设计如下：")]),_._v(" "),v("table",[v("thead",[v("tr",[v("th",[_._v("msg_id")]),_._v(" "),v("th",[_._v("count_key")]),_._v(" "),v("th",[_._v("count_value")])])]),_._v(" "),v("tbody",[v("tr",[v("td",[_._v("1")]),_._v(" "),v("td",[_._v("read")]),_._v(" "),v("td",[_._v("100000")])]),_._v(" "),v("tr",[v("td",[_._v("1")]),_._v(" "),v("td",[_._v("comment")]),_._v(" "),v("td",[_._v("1000")])])])]),_._v(" "),v("h3",{attrs:{id:"_3-4-读写效率问题"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-读写效率问题"}},[_._v("#")]),_._v(" 3.4 读写效率问题")]),_._v(" "),v("p",[_._v("对于计数系统来说，读的次数远远大于写的次数。"),v("strong",[_._v("因此，影响读写效率的主要是读操作")]),_._v("。对于redis的valu结构优化来说，写的话需要2次RPC，读的话仅需1次，使用写效率换读效率。")]),_._v(" "),v("h2",{attrs:{id:"🔗-参考链接"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#🔗-参考链接"}},[_._v("#")]),_._v(" 🔗 参考链接")]),_._v(" "),v("ul",[v("li",[v("a",{attrs:{href:"https://mp.weixin.qq.com/s/vKV0ENUdCmjgRvt8MV-C2Q",target:"_blank",rel:"noopener noreferrer"}},[_._v("每秒30W次的点赞业务，怎么优化？"),v("OutboundLink")],1)])])])}),[],!1,null,null,null);t.default=r.exports}}]);