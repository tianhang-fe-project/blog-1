<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>基础、编码和优化 MongoDB实战读书笔记 | 心谭博客</title>
    <meta name="description" content="专注前端与算法的博客">
    <script type="text/javascript" src="/scripts/baidu-analytics.js" async=""></script>
  <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.8c46daec.css" as="style"><link rel="preload" href="/assets/js/app.796cce09.js" as="script"><link rel="preload" href="/assets/js/2.e1e0c7d5.js" as="script"><link rel="preload" href="/assets/js/3.facfa05b.js" as="script"><link rel="preload" href="/assets/js/163.c87c5933.js" as="script"><link rel="preload" href="/assets/js/5.937ae87d.js" as="script"><link rel="prefetch" href="/assets/js/10.7840874b.js"><link rel="prefetch" href="/assets/js/100.121c62f5.js"><link rel="prefetch" href="/assets/js/101.dbbe1f43.js"><link rel="prefetch" href="/assets/js/102.ce51633a.js"><link rel="prefetch" href="/assets/js/103.0e02c3cb.js"><link rel="prefetch" href="/assets/js/104.64230d4e.js"><link rel="prefetch" href="/assets/js/105.660f4777.js"><link rel="prefetch" href="/assets/js/106.067d4e80.js"><link rel="prefetch" href="/assets/js/107.914e5858.js"><link rel="prefetch" href="/assets/js/108.c9772201.js"><link rel="prefetch" href="/assets/js/109.aee93860.js"><link rel="prefetch" href="/assets/js/11.ac257d6e.js"><link rel="prefetch" href="/assets/js/110.f985df39.js"><link rel="prefetch" href="/assets/js/111.a4e9a512.js"><link rel="prefetch" href="/assets/js/112.e663d426.js"><link rel="prefetch" href="/assets/js/113.2dfcb751.js"><link rel="prefetch" href="/assets/js/114.7a944add.js"><link rel="prefetch" href="/assets/js/115.75f2b807.js"><link rel="prefetch" href="/assets/js/116.b82c0bfb.js"><link rel="prefetch" href="/assets/js/117.63a95674.js"><link rel="prefetch" href="/assets/js/118.534a2a0f.js"><link rel="prefetch" href="/assets/js/119.ba157d6a.js"><link rel="prefetch" href="/assets/js/12.a6e07cb1.js"><link rel="prefetch" href="/assets/js/120.0e33121a.js"><link rel="prefetch" href="/assets/js/121.cfd680d6.js"><link rel="prefetch" href="/assets/js/122.3766e467.js"><link rel="prefetch" href="/assets/js/123.73f2d6f7.js"><link rel="prefetch" href="/assets/js/124.bb56d4d9.js"><link rel="prefetch" href="/assets/js/125.231759ac.js"><link rel="prefetch" href="/assets/js/126.2ff2e107.js"><link rel="prefetch" href="/assets/js/127.d4904459.js"><link rel="prefetch" href="/assets/js/128.3462c6f7.js"><link rel="prefetch" href="/assets/js/129.847591e6.js"><link rel="prefetch" href="/assets/js/13.a8c6b11b.js"><link rel="prefetch" href="/assets/js/130.74689f33.js"><link rel="prefetch" href="/assets/js/131.7deb2d07.js"><link rel="prefetch" href="/assets/js/132.47c4545e.js"><link rel="prefetch" href="/assets/js/133.d5c0c93d.js"><link rel="prefetch" href="/assets/js/134.5b9ea12b.js"><link rel="prefetch" href="/assets/js/135.521389b9.js"><link rel="prefetch" href="/assets/js/136.e403e841.js"><link rel="prefetch" href="/assets/js/137.721a9a1e.js"><link rel="prefetch" href="/assets/js/138.e41edead.js"><link rel="prefetch" href="/assets/js/139.5d1746c5.js"><link rel="prefetch" href="/assets/js/14.bb39005e.js"><link rel="prefetch" href="/assets/js/140.8742e3eb.js"><link rel="prefetch" href="/assets/js/141.5661ec9a.js"><link rel="prefetch" href="/assets/js/142.44871095.js"><link rel="prefetch" href="/assets/js/143.3ea75964.js"><link rel="prefetch" href="/assets/js/144.96969688.js"><link rel="prefetch" href="/assets/js/145.0d23ebd5.js"><link rel="prefetch" href="/assets/js/146.a0ddc91e.js"><link rel="prefetch" href="/assets/js/147.60f1e4dd.js"><link rel="prefetch" href="/assets/js/148.15dd1885.js"><link rel="prefetch" href="/assets/js/149.38af1de0.js"><link rel="prefetch" href="/assets/js/15.7113ef47.js"><link rel="prefetch" href="/assets/js/150.80fe0c27.js"><link rel="prefetch" href="/assets/js/151.7d84e079.js"><link rel="prefetch" href="/assets/js/152.7e2eba95.js"><link rel="prefetch" href="/assets/js/153.b98584ac.js"><link rel="prefetch" href="/assets/js/154.ba751953.js"><link rel="prefetch" href="/assets/js/155.e56b983e.js"><link rel="prefetch" href="/assets/js/156.3bd14e7b.js"><link rel="prefetch" href="/assets/js/157.93bd8a8e.js"><link rel="prefetch" href="/assets/js/158.eb78a787.js"><link rel="prefetch" href="/assets/js/159.9d421dc2.js"><link rel="prefetch" href="/assets/js/16.ac258be7.js"><link rel="prefetch" href="/assets/js/160.28b01ab5.js"><link rel="prefetch" href="/assets/js/161.5b62deb8.js"><link rel="prefetch" href="/assets/js/162.0ce0ed1a.js"><link rel="prefetch" href="/assets/js/164.76aa812b.js"><link rel="prefetch" href="/assets/js/165.ac747d8f.js"><link rel="prefetch" href="/assets/js/166.27f0d74b.js"><link rel="prefetch" href="/assets/js/167.5f1ec5fc.js"><link rel="prefetch" href="/assets/js/168.fc648a6a.js"><link rel="prefetch" href="/assets/js/169.1462974c.js"><link rel="prefetch" href="/assets/js/17.8cc762de.js"><link rel="prefetch" href="/assets/js/170.161fae48.js"><link rel="prefetch" href="/assets/js/171.2c89e0fd.js"><link rel="prefetch" href="/assets/js/172.d65587f3.js"><link rel="prefetch" href="/assets/js/18.485b4cdf.js"><link rel="prefetch" href="/assets/js/19.43a703c5.js"><link rel="prefetch" href="/assets/js/20.2913a4af.js"><link rel="prefetch" href="/assets/js/21.8d68d911.js"><link rel="prefetch" href="/assets/js/22.e05a1394.js"><link rel="prefetch" href="/assets/js/23.68e82a67.js"><link rel="prefetch" href="/assets/js/24.41d656e2.js"><link rel="prefetch" href="/assets/js/25.315f9fc2.js"><link rel="prefetch" href="/assets/js/26.4da73a77.js"><link rel="prefetch" href="/assets/js/27.1ad7543a.js"><link rel="prefetch" href="/assets/js/28.28dc36e8.js"><link rel="prefetch" href="/assets/js/29.d542a18d.js"><link rel="prefetch" href="/assets/js/30.5913ee80.js"><link rel="prefetch" href="/assets/js/31.96c515bc.js"><link rel="prefetch" href="/assets/js/32.832d2769.js"><link rel="prefetch" href="/assets/js/33.0b5f2b6c.js"><link rel="prefetch" href="/assets/js/34.f0a43b54.js"><link rel="prefetch" href="/assets/js/35.393f5115.js"><link rel="prefetch" href="/assets/js/36.6931f3d3.js"><link rel="prefetch" href="/assets/js/37.3af59799.js"><link rel="prefetch" href="/assets/js/38.187b03ec.js"><link rel="prefetch" href="/assets/js/39.ef86e799.js"><link rel="prefetch" href="/assets/js/4.2c2796bf.js"><link rel="prefetch" href="/assets/js/40.cb569c3b.js"><link rel="prefetch" href="/assets/js/41.6a2b99f8.js"><link rel="prefetch" href="/assets/js/42.687b56eb.js"><link rel="prefetch" href="/assets/js/43.05284af3.js"><link rel="prefetch" href="/assets/js/44.0b67307e.js"><link rel="prefetch" href="/assets/js/45.7f6ef1f3.js"><link rel="prefetch" href="/assets/js/46.8249bf7e.js"><link rel="prefetch" href="/assets/js/47.ec5f420e.js"><link rel="prefetch" href="/assets/js/48.d11a6c13.js"><link rel="prefetch" href="/assets/js/49.e6449fe8.js"><link rel="prefetch" href="/assets/js/50.915ae3af.js"><link rel="prefetch" href="/assets/js/51.f88017be.js"><link rel="prefetch" href="/assets/js/52.19883d30.js"><link rel="prefetch" href="/assets/js/53.fae82d2a.js"><link rel="prefetch" href="/assets/js/54.45609db2.js"><link rel="prefetch" href="/assets/js/55.19ea18af.js"><link rel="prefetch" href="/assets/js/56.542d82f1.js"><link rel="prefetch" href="/assets/js/57.98d9372d.js"><link rel="prefetch" href="/assets/js/58.188a7c01.js"><link rel="prefetch" href="/assets/js/59.ee218327.js"><link rel="prefetch" href="/assets/js/6.c085291d.js"><link rel="prefetch" href="/assets/js/60.2bcf90df.js"><link rel="prefetch" href="/assets/js/61.9de5ce4c.js"><link rel="prefetch" href="/assets/js/62.6f5dbe75.js"><link rel="prefetch" href="/assets/js/63.4e662f41.js"><link rel="prefetch" href="/assets/js/64.4befdf87.js"><link rel="prefetch" href="/assets/js/65.0df2e097.js"><link rel="prefetch" href="/assets/js/66.194207b7.js"><link rel="prefetch" href="/assets/js/67.2f017eb6.js"><link rel="prefetch" href="/assets/js/68.d7c1c8c6.js"><link rel="prefetch" href="/assets/js/69.0197aa54.js"><link rel="prefetch" href="/assets/js/7.33994ffb.js"><link rel="prefetch" href="/assets/js/70.c5bd7f06.js"><link rel="prefetch" href="/assets/js/71.0bb79493.js"><link rel="prefetch" href="/assets/js/72.305e2f8e.js"><link rel="prefetch" href="/assets/js/73.cf049b79.js"><link rel="prefetch" href="/assets/js/74.e6a8dc79.js"><link rel="prefetch" href="/assets/js/75.09c99a8b.js"><link rel="prefetch" href="/assets/js/76.03391a48.js"><link rel="prefetch" href="/assets/js/77.b6b1f159.js"><link rel="prefetch" href="/assets/js/78.68290187.js"><link rel="prefetch" href="/assets/js/79.3f3a989b.js"><link rel="prefetch" href="/assets/js/8.8e0ec08a.js"><link rel="prefetch" href="/assets/js/80.a9997b21.js"><link rel="prefetch" href="/assets/js/81.16b25dd6.js"><link rel="prefetch" href="/assets/js/82.0d4b5429.js"><link rel="prefetch" href="/assets/js/83.dd1d56ff.js"><link rel="prefetch" href="/assets/js/84.647ed736.js"><link rel="prefetch" href="/assets/js/85.42beef75.js"><link rel="prefetch" href="/assets/js/86.71a0ec17.js"><link rel="prefetch" href="/assets/js/87.bfe0afb3.js"><link rel="prefetch" href="/assets/js/88.47b7669f.js"><link rel="prefetch" href="/assets/js/89.728d0788.js"><link rel="prefetch" href="/assets/js/9.34339a8e.js"><link rel="prefetch" href="/assets/js/90.6d89e6aa.js"><link rel="prefetch" href="/assets/js/91.6a344cf8.js"><link rel="prefetch" href="/assets/js/92.dfa3fa12.js"><link rel="prefetch" href="/assets/js/93.03d110a3.js"><link rel="prefetch" href="/assets/js/94.5fe424b6.js"><link rel="prefetch" href="/assets/js/95.bceaf616.js"><link rel="prefetch" href="/assets/js/96.bd876d2a.js"><link rel="prefetch" href="/assets/js/97.2b033676.js"><link rel="prefetch" href="/assets/js/98.eb9cfac4.js"><link rel="prefetch" href="/assets/js/99.d5daa6b0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8c46daec.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">心谭博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://xxoo521.com/frontend/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端图谱
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://xxoo521.com/algorithm/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  算法题解
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://xxoo521.com/archives/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  文章归档
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/dongyuanxin/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://xxoo521.com/frontend/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端图谱
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://xxoo521.com/algorithm/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  算法题解
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://xxoo521.com/archives/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  文章归档
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/dongyuanxin/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><blockquote><p>这是阅读《MongoDB实战》所做的，关于基础、编码和优化方面的读书笔记。</p></blockquote> <h2 id="mongodb特性和介绍"><a href="#mongodb特性和介绍" class="header-anchor">#</a> MongoDB特性和介绍</h2> <h3 id="_1-简介"><a href="#_1-简介" class="header-anchor">#</a> 1. 简介</h3> <p>MongoDB的特点：扩展策略、直观的数据模型。在mongodb中，编程语言定义的对象能被“原封不变”地持久化，消除对象结构和程序映射的复杂性。</p> <h3 id="_2-主要特性"><a href="#_2-主要特性" class="header-anchor">#</a> 2. 主要特性</h3> <h4 id="数据模型"><a href="#数据模型" class="header-anchor">#</a> 数据模型</h4> <p>关系型与正规化：对于关系型数据库，数据表本质上是<strong>扁平的</strong>，因此表示多个一对多关系就需要多张表。经常用到的技术是<strong>拆表</strong>，这种技术是<strong>正规化</strong>。</p> <p>但对于Mongo来说，文档支持嵌套等多种格式，无需事先定义<strong>Schema</strong>。</p> <h4 id="即时查询"><a href="#即时查询" class="header-anchor">#</a> 即时查询</h4> <p>mysql和mongodb都支持<strong>即时查询</strong>，不同的是：前者依赖正则化的模型；后者假定查询字段是存储与文档中的。</p> <h4 id="二级索引"><a href="#二级索引" class="header-anchor">#</a> 二级索引</h4> <p>mongodb支持二级索引，是通过b-tree实现的。</p> <h4 id="复制"><a href="#复制" class="header-anchor">#</a> 复制</h4> <p>通过<strong>副本集</strong>的拓扑结构来提供复制功能，其目的是：<strong>提供数据的冗余</strong>。</p> <p>副本集的主节点能接受读写操作，但从节点是只读的。主节点出问题，会自动故障转移，选取一个从节点升级为主节点。</p> <h4 id="写速度和持久性"><a href="#写速度和持久性" class="header-anchor">#</a> 写速度和持久性</h4> <p>写速度：给定时间内，数据库可以处理的插入、更新和删除操作的数量。</p> <p>持久性：数据库保持上述写操作的结果不改变的，所用的时间长短。</p> <p>DB领域，<strong>写速度和持久性存在一种相反关系</strong>。很好理解，例如memcached，直接写入内存，写速度非常快，但同时数据完全易失。</p> <p>mongodb的写操作，默认是<strong>fire-and-forget</strong>：通过TCP发送写操作，不要求数据库应答。用户可以开启<strong>安全模式</strong>，保证写操作正确无误写入db。并且安全模式可以配置，用于<strong>阻塞操作</strong>。</p> <p>对于高容量、低价值数据（点击流、日志），默认模式更优；对于重要数据，倾向于安全模式。</p> <p>mongo中，<strong>Journaling日志</strong>默认开启。所有写操作会被提交到一个只能追加的日志中。以应对故障后的，重启修复服务。</p> <h4 id="数据库扩展"><a href="#数据库扩展" class="header-anchor">#</a> 数据库扩展</h4> <ul><li>垂直扩展（向上扩展）：升级硬件，来提高单点性能</li> <li>水平扩展（向外扩展）：将数据库分布到多台机器，是基于<strong>自动分片</strong>。其中，单独的分片由一个副本集组成，至少有2个节点，保证没有单点失败。</li></ul> <h3 id="_3-核心服务器和工具"><a href="#_3-核心服务器和工具" class="header-anchor">#</a> 3. 核心服务器和工具</h3> <h4 id="核心服务器"><a href="#核心服务器" class="header-anchor">#</a> 核心服务器</h4> <p>通过<code>mongod</code>可以运行核心服务器。数据文件存储在<code>/data/db</code>中。如果下载编译mongo的源代码，需要手动创建<code>/data/db</code>，并且为其分配权限。</p> <p>其中，mongo的<strong>内存管理</strong>是由操作系统来处理的。数据文件通过<code>mmap()</code>系统API，映射成系统的虚拟内存。</p> <h4 id="命令行"><a href="#命令行" class="header-anchor">#</a> 命令行</h4> <p>是基于JavaScript编写的。所以能看到很多通用的语法，以及输出的格式。</p> <h4 id="数据库驱动"><a href="#数据库驱动" class="header-anchor">#</a> 数据库驱动</h4> <p>针对多个语言，都提供了<strong>驱动</strong>使用。并且风格几乎保持统一的API接口。</p> <h4 id="命令行工具"><a href="#命令行工具" class="header-anchor">#</a> 命令行工具</h4> <p>安装到MaxOS后，全局会多出以下命令：</p> <ul><li><code>mongodump</code>和<code>mongorestore</code>：前者用<code>BSON</code>格式，来备份数据库数据。方便后者恢复。</li> <li><code>mongoexport</code>和<code>mongoimport</code>：导入导出JSON、CSV和TSV格式数据。</li></ul> <h3 id="_4-mongo的场景"><a href="#_4-mongo的场景" class="header-anchor">#</a> 4. Mongo的场景</h3> <p>适用于<strong>事先无法知晓数据结构</strong>的数据，或者<strong>数据结构经常不确定性较大</strong>的数据。</p> <p>除此之外，还适用于<strong>与分析相关的场景</strong>。mongo提供一种<strong>固定集合</strong>，常用于日志，特点是<strong>分配的大小固定</strong>，类似于循环队列。</p> <h3 id="_5-局限"><a href="#_5-局限" class="header-anchor">#</a> 5. 局限</h3> <p>由于使用内存映射，32位系统只能对4GB内存寻址。一半内存被os占用，那么只有2GB能用来做映射文件。所以，<strong>必须部署在64位操作系统上</strong>。</p> <h2 id="程序编写基础"><a href="#程序编写基础" class="header-anchor">#</a> 程序编写基础</h2> <p>mongo驱动的find方法，返回的是<strong>游标对象</strong>，可以理解为迭代器的下标。在NodeJS中，它的名字和类型是<code>Cursor</code>。</p> <p>在Nodejs中，</p> <h3 id="_1-驱动工作原理"><a href="#_1-驱动工作原理" class="header-anchor">#</a> 1. 驱动工作原理</h3> <p>主要有3个功能：</p> <ol><li>生成MongoDB对象的ID，它是存储在<code>_id</code>字段中的默认值</li> <li>驱动会把特定语言的文档表述，和<code>BSON</code>互换</li> <li>使用TCP套接字与数据库通信</li></ol> <h4 id="对象id"><a href="#对象id" class="header-anchor">#</a> 对象ID</h4> <p>在自带的交互式命令行中:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&gt;</span> id <span class="token operator">=</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">&quot;5d9413867cc8dacf9247fe3e&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>对于生成的<code>5d9413867cc8dacf9247fe3e</code>:</p> <pre><code>- 5d941386 ，这4个字节是时间戳，单位秒数
- 7cc8da，机器ID
- cf92，进程ID
- 47fe3e，计数器
</code></pre> <h3 id="_2-安全写入模式-write-concern"><a href="#_2-安全写入模式-write-concern" class="header-anchor">#</a> 2. 安全写入模式(Write Concern)</h3> <p>对所有的写操作（插入、更新或删除）都能开启此模式。以此保证，操作一定在数据库层面生效。</p> <p>在v4.0中，以insert为例，文档如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>db<span class="token punctuation">.</span>collection<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>
   <span class="token operator">&lt;</span>document or array <span class="token keyword">of</span> documents<span class="token operator">&gt;</span><span class="token punctuation">,</span>
   <span class="token punctuation">{</span>
     writeConcern<span class="token punctuation">:</span> <span class="token operator">&lt;</span>document<span class="token operator">&gt;</span><span class="token punctuation">,</span>
     ordered<span class="token punctuation">:</span> <span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>关于 Write Concern的详细参数，可以看这篇文档：https://docs.mongodb.com/manual/reference/write-concern/</p> <p>其中，重要的是<code>w</code> 参数，它可以指定是否使用应答写入。目前默认是1，应答式写入。设置为0，则是非应答式。</p> <h2 id="面向文档的数据"><a href="#面向文档的数据" class="header-anchor">#</a> 面向文档的数据</h2> <h3 id="_1-schema-设计原则"><a href="#_1-schema-设计原则" class="header-anchor">#</a> 1. Schema 设计原则</h3> <p>设计数据库Schema式根据数据库特点和应用程序需求的情况下，为数据集选择最佳表述的过程。</p> <h3 id="_2-设计电子商务数据模型"><a href="#_2-设计电子商务数据模型" class="header-anchor">#</a> 2. 设计电子商务数据模型</h3> <h4 id="一对多：产品和分类"><a href="#一对多：产品和分类" class="header-anchor">#</a> 一对多：产品和分类</h4> <p>假设一个电商场景，要对一个商品doc进行设计。对于商品，它有多个分类category，因此需要<strong>一对多操作</strong>，同时，mongo不支持联结操作（join）。</p> <p>因此解决方案是，在商品的一个字段中，保存<strong>分类指针</strong>的数组。这里的指针，就是mongo中的对象ID。</p> <p>下面是一个简单的例子：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&gt; db.products.find()
{ &quot;_id&quot; : ObjectId(&quot;5d9423257cc8dacf9247fe41&quot;), &quot;categories&quot; : [ ObjectId(&quot;5d9423017cc8dacf9247fe3f&quot;) ] }
&gt; db.categories.find({})
{ &quot;_id&quot; : ObjectId(&quot;5d9423017cc8dacf9247fe3f&quot;), &quot;name&quot; : &quot;分类1&quot; }
{ &quot;_id&quot; : ObjectId(&quot;5d9423037cc8dacf9247fe40&quot;), &quot;name&quot; : &quot;分类2&quot; }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="一对多：用户与订单"><a href="#一对多：用户与订单" class="header-anchor">#</a> 一对多：用户与订单</h4> <p>和前面的关系不同，这里的“多”体现在“订单”上。这里的订单中，保存着指向用户的指针。</p> <h4 id="评论"><a href="#评论" class="header-anchor">#</a> 评论</h4> <p>每个产品会有多个评论，而每个评论，可能会有点赞人列表。当要展示返回给前端的时候，需要获取产品评论，并且获取点赞人列表。</p> <p>方案1：点赞人列表，保存着由指针组成的集合。可以先查询产品评论后，再对点赞做2次查询。</p> <p>方案2：由于仅需要点赞人的头像和名称（少量信息），可以使用<strong>去正规化</strong>，不再保存指针，而是简单信息。</p> <p>上面2种方案，都可以防止重复点赞的发生。</p> <h3 id="_3-具体细节"><a href="#_3-具体细节" class="header-anchor">#</a> 3. 具体细节</h3> <h4 id="数据库"><a href="#数据库" class="header-anchor">#</a> 数据库</h4> <p>即使使用<code>use</code>切换一个新的数据库，如果没有insert数据，该数据库并不会创建。</p> <p>mongodb会为数据、集合、索引进行空间分配，并且采取的是<strong>预分配</strong>的方式，每次空间不够的时候，扩充2倍。</p> <p>通过 <code>db.stats()</code> 可以查看当前db的状态，下面是一个示例：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&gt;</span> db<span class="token punctuation">.</span><span class="token function">stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token string">&quot;db&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;info_keeper&quot;</span><span class="token punctuation">,</span>
	<span class="token string">&quot;collections&quot;</span> <span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
	<span class="token string">&quot;views&quot;</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token string">&quot;objects&quot;</span> <span class="token punctuation">:</span> <span class="token number">11</span><span class="token punctuation">,</span>
	<span class="token string">&quot;avgObjSize&quot;</span> <span class="token punctuation">:</span> <span class="token number">255.8181818181818</span><span class="token punctuation">,</span>
	<span class="token string">&quot;dataSize&quot;</span> <span class="token punctuation">:</span> <span class="token number">2814</span><span class="token punctuation">,</span> <span class="token comment">// 数据库中BSON对象实际大小</span>
	<span class="token string">&quot;storageSize&quot;</span> <span class="token punctuation">:</span> <span class="token number">86016</span><span class="token punctuation">,</span> <span class="token comment">// 包含了集合增长的预留空间和未分配的已删除空间</span>
	<span class="token string">&quot;numExtents&quot;</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token string">&quot;indexes&quot;</span> <span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
	<span class="token string">&quot;indexSize&quot;</span> <span class="token punctuation">:</span> <span class="token number">155648</span><span class="token punctuation">,</span> <span class="token comment">// 数据库索引大小的空间</span>
	<span class="token string">&quot;fsUsedSize&quot;</span> <span class="token punctuation">:</span> <span class="token number">86272356352</span><span class="token punctuation">,</span>
	<span class="token string">&quot;fsTotalSize&quot;</span> <span class="token punctuation">:</span> <span class="token number">250685575168</span><span class="token punctuation">,</span> 
	<span class="token string">&quot;ok&quot;</span> <span class="token punctuation">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="集合"><a href="#集合" class="header-anchor">#</a> 集合</h4> <p>1、重命名操作：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&gt;</span> use test
<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>orders<span class="token punctuation">.</span><span class="token function">renameCollection</span><span class="token punctuation">(</span> <span class="token string">&quot;orders2014&quot;</span> <span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>2、固定集合</p> <p>对应日志统计之类的、<strong>只有最近的数据才有价值</strong>的场景下，可以使用<strong>固定集合</strong>：一旦容量到上限，后续插入会逐步覆盖最先插入的文档。</p> <p>创建时候，需要同时指定<code>createCollection</code>的capped和size参数：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>db.createCollection('logs',{ capped : true, size : 5242880 })
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>为了性能优化，mongo<strong>不会为固定集合创建针对<code>_id</code>的索引</strong>。同时，不能从中删除doc，也不能执行任何更改文档大小的更新操作。</p> <p>3、键名选择</p> <p><strong>慎重选择键名</strong>，例如，用<code>dob</code>代替<code>date_of_birth</code>，一个文档可以省下10字节。</p> <h2 id="查询和聚合"><a href="#查询和聚合" class="header-anchor">#</a> 查询和聚合</h2> <h3 id="_1-查询常见技巧"><a href="#_1-查询常见技巧" class="header-anchor">#</a> 1. 查询常见技巧</h3> <p><strong>分页查询</strong>可以通过<code>skip</code>和<code>limit</code>配合使用实现。</p> <p><strong>空值查询</strong>可以通过驱动的空值字面量实现，比如在node中，想查询<code>logs</code>中不包含<code>name</code>字段的记录：<code>db.logs.find({ name: null })</code>。</p> <p><strong>减少序列化和网络传输</strong>，可以通过给定find的第二个参数，来选定数据库返回给驱动的文档的字段，比如：<code>db.products.find({}, {_id: 1})</code>。这条命令，只返回文档的<code>_id</code>字段。</p> <p><strong>复合索引</strong>，复合索引的设定，遵循着「从准确到宽泛」的规则。比如对于订单记录，有着下单人和时间2个字段。应该先为下单人字段设置索引，再为时间字段设置索引。可以理解为前者是精确查找，可以大大缩小查找结果集；后者是范围查找。</p> <p><strong>嵌套字段查询</strong>，对于负责对象字段的查询，直接通过<code>.</code>运算符即可。例如：<code>db.demos.find({a: {b : 1}})</code>和<code>db.demos.find({&quot;a.b&quot;: 1})</code> 是等效的。</p> <h3 id="_2-常见查询语言"><a href="#_2-常见查询语言" class="header-anchor">#</a> 2. 常见查询语言</h3> <p>MongoDB的查询本质：实例化了一个游标，并获取它的结果集。</p> <h4 id="范围查询"><a href="#范围查询" class="header-anchor">#</a> 范围查询</h4> <p>范围操作符用法很简单，但注意：不要在范围查找时候误用<strong>重复搜索键</strong>。</p> <p>错误：<code>db.users.find({age: { $gte: 0 }, age: { $lte: 30 } })</code></p> <p>正确：<code>db.users.find({age: {$gte: 0, $lte: 30}})</code></p> <h4 id="集合操作"><a href="#集合操作" class="header-anchor">#</a> 集合操作</h4> <p>集合操作符一共有3个：<code>$in</code>、<code>$all</code>、<code>$nin</code>。</p> <p>in和nin是一对，in相当于使用多个OR操作符：<code>db.products.find({'tags': {$in: [ObjectId('...'), ObjectId('...')]}})</code></p> <p>all的作用属性，必须是数组形式：<code>db.products.find({tags: {$all: ['a', 'b']}})</code></p> <p>⚠️注意：in和all可以利用索引；nin不能利用索引，只能使用<strong>集合扫描</strong>。这和BTree结构有关。</p> <h4 id="布尔操作"><a href="#布尔操作" class="header-anchor">#</a> 布尔操作</h4> <p>常见的有：<code>$ne</code>、<code>$not</code>、 <code>$or</code>、 <code>$and</code>、<code>$exists</code>。同样的，<code>$ne</code>不能利用索引。</p> <p>对于not的使用，如果使用的操作符或者正则表达式不存在否定形式，才配合not。例如大于，就有小于等于操作符。</p> <p>对与or的使用，or可以<strong>表示不同键的值的关系</strong>，而in只能表示一个键的值的关系。例如：<code>db.products.find({ $or: [{ name: 'a' }, { name: 'b' }] })</code></p> <h4 id="子文档"><a href="#子文档" class="header-anchor">#</a> 子文档</h4> <p>对于内嵌对象匹配，用<code>.</code>运算符即可，正如前面的嵌套字段查询所述。</p> <p><strong>不推荐</strong>对于整个对象的查询，需要严格保证查询字段的顺序。</p> <h4 id="数组"><a href="#数组" class="header-anchor">#</a> 数组</h4> <p>如果数组中元素是基础对象，那么直接查询即可。mongo识别字段是数组类型，会自动查询字段是否位于其中。</p> <p>例如：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token operator">&gt;</span> db.products.insert<span class="token punctuation">(</span><span class="token punctuation">{</span>tags: <span class="token punctuation">[</span><span class="token string">'a'</span>, <span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
WriteResult<span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">&quot;nInserted&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">&gt;</span> db.products.find<span class="token punctuation">(</span><span class="token punctuation">{</span>tags: <span class="token string">'a'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5d948025da0946c664997712&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;tags&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;a&quot;</span>, <span class="token string">&quot;b&quot;</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>如果数组中元素是负责对象，可以借助<code>.</code>运算符进行访问：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token operator">&gt;</span> db.products.insert<span class="token punctuation">(</span><span class="token punctuation">{</span>address: <span class="token punctuation">[</span><span class="token punctuation">{</span>name: <span class="token string">'home'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
WriteResult<span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">&quot;nInserted&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">&gt;</span> db.products.find<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;address.name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">'home'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5d948055da0946c664997713&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;address&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;home&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>同样地，你也可以指定针对特定顺序的数组元素：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token operator">&gt;</span> db.products.find<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;address.0.name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">'home'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5d948055da0946c664997713&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;address&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;home&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>如果要同时将<strong>多个条件限制在同一个子文档</strong>上，下面是错误和正确的做法👇</p> <p>错误：<code>db.products.find({&quot;address.name&quot;: 'home', 'address.state': 'NY'})</code></p> <p>正确：<code>db.products.find({address: {$elemMatch: {name: 'home', state: 'NY'} }})</code></p> <h4 id="javascript查询"><a href="#javascript查询" class="header-anchor">#</a> Javascript查询</h4> <p>对于一些复杂查询，借助<code>$where</code>可以使用js表达式。还是以刚才的数据为例：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token operator">&gt;</span> db.products.find<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token variable">$where</span><span class="token builtin class-name">:</span> <span class="token string">&quot;function() {return this.address &amp;&amp; this.address.length}&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5d948055da0946c664997713&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;address&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;home&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在使用的时候，需要启动js解释器和上下文，因此<strong>开销大</strong>。在使用的时候，尽量带上其他标准查询操作，来缩小查询范围。</p> <p>除此之外，还有注入攻击的可能。主要体现在驱动使用时候，如果后端传给db的字段是没做检验的，可能发生注入攻击。</p> <h4 id="正则表达式"><a href="#正则表达式" class="header-anchor">#</a> 正则表达式</h4> <p>主要体现在驱动使用上。</p> <p>如果支持js的正则，那么可以: <code>find({text: /best/i})</code></p> <p>如果不支持，那么：<code>find({text: {$regex: 'best', $options: 'i'}})</code></p> <h4 id="类型"><a href="#类型" class="header-anchor">#</a> 类型</h4> <p>通过<code>$type</code>，可以根据指定字段类型进行查询。不同的值，代表不同的类型。请见官方文档。</p> <h3 id="_3-查询选项"><a href="#_3-查询选项" class="header-anchor">#</a> 3. 查询选项</h3> <h4 id="投影"><a href="#投影" class="header-anchor">#</a> 投影</h4> <p>1、使用选择字段进行返回，降低网络传输：<code>find</code>给定第二个参数。</p> <p>2、返回保存在结果数组中的某个范围的值：<code>$slice([start, limit])</code>。例如：<code>db.products.find({}, { comments: {$slice: 12}})</code></p> <h4 id="排序"><a href="#排序" class="header-anchor">#</a> 排序</h4> <p>能够对<strong>多个字段</strong>进行升序/降序排列。例如：<code>db.comments.find().sort({rating: -1, votes: -1})</code></p> <h4 id="skip和limit"><a href="#skip和limit" class="header-anchor">#</a> skip和limit</h4> <p>如果向skip传入很大的值，需要扫描同等数量的文档，浪费资源。</p> <p>最好的方法是：通过查询条件，缩小要扫描的文档。</p> <h3 id="_4-聚合指令"><a href="#_4-聚合指令" class="header-anchor">#</a> 4. 聚合指令</h3> <p>在v2的版本中，mongo只能通过map、reduce等基础操作来支持聚合搜索。但在v3的版本后，mongo本身提供了丰富的聚合阶段(<a href="https://docs.mongodb.com/manual/reference/operator/aggregation-pipeline" target="_blank" rel="noopener noreferrer">aggregation pipeline<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)和聚合运算符(<a href="https://docs.mongodb.com/manual/reference/operator/aggregation/" target="_blank" rel="noopener noreferrer">aggregation operator<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)。</p> <p>以<code>$group</code>和<code>$sum</code>为例，插入了a和b两种售卖货物以及价钱：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token operator">&gt;</span> db.sales.<span class="token function-name function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5d98ca8094ffea590a8a85c6&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;a&quot;</span>, <span class="token string">&quot;coin&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">100</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5d98ca8694ffea590a8a85c7&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;a&quot;</span>, <span class="token string">&quot;coin&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">200</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5d98ca9094ffea590a8a85c8&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;b&quot;</span>, <span class="token string">&quot;coin&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">800</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>利用聚合操作，就可以便捷算出每种货物的总价：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token operator">&gt;</span> db.sales.aggregate<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token variable">$group</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> _id: <span class="token string">&quot;<span class="token variable">$name</span>&quot;</span>, total: <span class="token punctuation">{</span> <span class="token variable">$sum</span><span class="token builtin class-name">:</span> <span class="token string">&quot;<span class="token variable">$coin</span>&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;b&quot;</span>, <span class="token string">&quot;total&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">800</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;a&quot;</span>, <span class="token string">&quot;total&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">300</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>最后说一下，聚合的意义在于数据库提供给使用者此种功能以及相关优化。当然，使用者完全可以在逻辑层面查询到需要的集合，代码中进行计算。但对于服务的提供商，完整的服务是必不可少的。</p> <h2 id="更新、原子操作与删除"><a href="#更新、原子操作与删除" class="header-anchor">#</a> 更新、原子操作与删除</h2> <h3 id="_1-文档更新入门"><a href="#_1-文档更新入门" class="header-anchor">#</a> 1. 文档更新入门</h3> <p>文档更新分为：替换更新和针对性更新。相较而言，<strong>针对性更新</strong>具有性能好、传输数据少和允许原子性更新的优点。</p> <p>利用<code>$set</code>和<code>$push</code>可以针对文档和其中的数组字段进行针对性更新，下面是针对性更新的例子：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>db.products.update<span class="token punctuation">(</span>
   <span class="token punctuation">{</span> _id: <span class="token number">100</span> <span class="token punctuation">}</span>,
   <span class="token punctuation">{</span> <span class="token variable">$set</span><span class="token builtin class-name">:</span>
      <span class="token punctuation">{</span>
        quantity: <span class="token number">500</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>如果是替换更新，遇到增加计数器值之类的场景，在不使用乐观锁的情况下，无法保证原子性更新。因为需要先读出数据，然后再更新。此过程中，可能会有其他并发程序重写字段，从而造成脏数据。</p> <p>以更新计数器的针对性更新为例：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>db.products.update<span class="token punctuation">(</span>
   <span class="token punctuation">{</span> sku: <span class="token string">&quot;abc123&quot;</span> <span class="token punctuation">}</span>,
   <span class="token punctuation">{</span> <span class="token variable">$inc</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> quantity: -1 <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_2-电子商务数据模型中的更新"><a href="#_2-电子商务数据模型中的更新" class="header-anchor">#</a> 2. 电子商务数据模型中的更新</h3> <h4 id="冗余字段设计"><a href="#冗余字段设计" class="header-anchor">#</a> 冗余字段设计</h4> <p>对于一些常见的结果，比如：总数、平均值等。为了避免每次都<strong>重新聚合运算</strong>，可以在文档中<strong>保存额外的字段缓存</strong>相关数据。</p> <p>之后的业务查询，仅仅需要查询一次即可。</p> <h4 id="操作符"><a href="#操作符" class="header-anchor">#</a> <code>$</code>操作符</h4> <p>作用：确定数组中一个要被更新的元素的位置，而不用具体指定该元素在数组中的位置。</p> <p>如下所示，不需要知道在grades数组中匹配的具体位置，用<code>$</code>指代即可：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&gt;</span> db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
   <span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;grades&quot;</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token number">85</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">80</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">updateOne</span><span class="token punctuation">(</span>
   <span class="token punctuation">{</span> _id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> grades<span class="token punctuation">:</span> <span class="token number">80</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">{</span> $<span class="token keyword">set</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;grades.$&quot;</span> <span class="token punctuation">:</span> <span class="token number">82</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="upsert操作符"><a href="#upsert操作符" class="header-anchor">#</a> <code>upsert</code>操作符</h4> <p>作用：如果不存在，则会自动<code>insert</code>。</p> <p>对于添加到商品到购物车等场景，非常适用。</p> <h3 id="_3-事务性工作流"><a href="#_3-事务性工作流" class="header-anchor">#</a> 3. 事务性工作流</h3> <p>这里主要使用的是<code>findAndModify</code>命令。这个命令，支持传入query参数，来做匹配筛选；支持update，来做针对性更新（原子更新）。最重要的特性是：<strong>可以根据<code>new</code>参数，来返回更新前后的文档数据状态</strong>。</p> <p>借助可以返回更新文档数据的特性，可以mock一下mongo 4.0之前不支持的事务特性。思路是：</p> <ol><li>获取最初的文档数据</li> <li>利用findAndModify进行针对性更新，更新字段中需要携带本次的更新标示（比如时间戳）。findAndModify操作符回返回更新后的字段。</li> <li>将更新后的字段中的更新标示与本地保存的标示做对比，如果不相同，说明有别的端更新了数据，数据发生了污染，为了保证事务原子性的特点，将文档恢复为第1步获得原始数据；如果相同，那么继续进行。</li></ol> <p>在MongoDB 4.0中，就是通过类似第二步的思路，提供了一个seesionID来实现了事务的，保证了事务特性。</p> <h3 id="_4-更多的更新命令"><a href="#_4-更多的更新命令" class="header-anchor">#</a> 4. 更多的更新命令</h3> <p>update：multi参数不给，默认只更新匹配到的第一个文档。</p> <p>unset：删除文档中的指定键。</p> <p>rename：重命名键。</p> <p>addToSet：数组中不存在时候，才会加入。</p> <p>pull：删除数组指定位置的元素。</p> <h3 id="_5-更新本质和优化"><a href="#_5-更新本质和优化" class="header-anchor">#</a> 5. 更新本质和优化</h3> <p>更新分为3种：</p> <ul><li>只改变单值，但BSON文档不变：<code>$inc</code>操作符</li> <li>改变文档和结构，会重写整个文档：<code>$push</code></li> <li>改变文档造成空间不够，全部整体迁移到新空间：提前利用<strong>填充因子</strong>来减少影响</li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/dongyuanxin/blog/edit/master/notes/5.MongoDB/1.基础、编码和优化.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">更新于:</span> <span class="time">10/11/2019, 8:35:37 AM</span></div></footer> <!----> <aside class="right-sidebar"><div class="right-sidebar-links"><div class="right-sidebar-header">关注公众号</div> <img src="https://static.godbmw.com/img/public/wechat-8cm.jpg" alt="公众号搜索：心谭博客" srcset></div> <div class="right-sidebar-links"><div class="right-sidebar-header">
      最近更新
      <a href="/guide/" target="_blank">&gt;&gt;&gt;查看全部</a></div> <div class="right-sidebar-item"><a target="_blank" href="/passages/2019-11-25-promise-a-plus/" title="让我们再聊聊Promise的实现">让我们再聊聊Promise的实现</a></div><div class="right-sidebar-item"><a target="_blank" href="/passages/2019-11-25-how-insist-on-learning/" title="如何保持保持高效学习？">如何保持保持高效学习？</a></div><div class="right-sidebar-item"><a target="_blank" href="/passages/2019-09-04-log-module/" title="日志库的实现机制与优化方法">日志库的实现机制与优化方法</a></div><div class="right-sidebar-item"><a target="_blank" href="/passages/2019-09-03-nodejs-watch-file/" title="NodeJS是如何监听文件的变化？">NodeJS是如何监听文件的变化？</a></div><div class="right-sidebar-item"><a target="_blank" href="/passages/2018-05-23-es-promise/" title="Promise 概述">Promise 概述</a></div><div class="right-sidebar-item"><a target="_blank" href="/passages/2019-11-23-promise-methods/" title="手写Promise的相关方法">手写Promise的相关方法</a></div><div class="right-sidebar-item"><a target="_blank" href="/passages/2019-11-11-wirte-virtual-dom/" title="一文说清「VirtualDOM」的含义与实现">一文说清「VirtualDOM」的含义与实现</a></div><div class="right-sidebar-item"><a target="_blank" href="/passages/2019-03-18-interview-js-code/" title="前端面试中常考的源码实现">前端面试中常考的源码实现</a></div></div> <div class="right-sidebar-links"><div class="right-sidebar-header">
      想法
      <a href="/passages/2019-11-25-how-insist-on-learning/" target="_blank">&gt;&gt;&gt;查看全部</a></div> <div title="如何保持保持高效学习？" class="right-sidebar-item"><a target="_blank" href="/passages/2019-11-25-how-insist-on-learning/" title="如何保持保持高效学习？">如何保持保持高效学习？</a></div></div></aside> </main></div><div class="global-ui"><div class="my-loader center" style="display:none;" data-v-354e1a9e><div class="my-loader-circle" data-v-354e1a9e></div></div><div class="my-popup" style="display:none;" data-v-3414bdeb><div class="my-popup-container" data-v-3414bdeb><div class="my-popup-exit" data-v-3414bdeb></div> <img src="" alt data-v-3414bdeb></div></div><!----><!----><div></div></div></div>
    <script src="/assets/js/app.796cce09.js" defer></script><script src="/assets/js/2.e1e0c7d5.js" defer></script><script src="/assets/js/3.facfa05b.js" defer></script><script src="/assets/js/163.c87c5933.js" defer></script><script src="/assets/js/5.937ae87d.js" defer></script>
  </body>
</html>
